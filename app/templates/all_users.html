{% extends "base.html" %}{% set active_page='all_users' %}

{% block title %}GMonster{% endblock %}

{% block page_content %}
<div class="table table-responsive-sm">
    <table id="all_users" class="table table-striped table-sm table-bordered">
        <thead>
            <tr>
                <th class="text-center">Email</th>
                <th class="text-center">Username</th>
                <th class="text-center">Time Created</th>
                <th class="text-center">Last Login Time</th>
                <th class="text-center">Activate</th>
                <th class="text-center">Delete</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    
</div>
<div class="container-fluid mx-2 my-1">
    <div class="row">
        <div class="col-lg-15 mx-auto">
            <div class="card card-signin my-5">
                <div class="card-body">
                    <h4 class="text-center">Create User</h4>
                    <form class="form-signup" method="POST" action="">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            {{ form.email.label(class="form-control-label") }} {{ form.email(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.username.label(class="form-control-label") }} {{ form.username(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.password.label(class="form-control-label") }} {{ form.password(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.re_password.label(class="form-control-label") }} {{ form.re_password(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.submit(class="btn btn-primary btn-block") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="delete_window" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-body mx-auto">
            <h4>Are you sure?</h4>
        </div>
        <div class="modal-footer mx-auto">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <a id="delete_confirm" class="btn btn-danger btn-ok" type="button" data-id="" onclick="delete_user(this)">Delete</a>
        </div>
    </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script type="text/javascript">
    function toObject(arr) {
        var rv = [];
        for (var i = 0; i < arr.length; ++i)
            rv[i] = arr[i];
        return rv;
    }


    function change_modal(e){
        if (e.dataset.type==='delete'){
            document.getElementById('delete_confirm').dataset.id = e.dataset.id
        }
    };


    function toggle_account_status(e) {
        if (e.dataset.state==='1') {

            e.dataset.state = '0';
            change_user_status(e, false);
        } else {
            // turning active
            e.dataset.state = '1';
            change_user_status(e, true);
        }
        
    }


    function change_user_status(e, flag){

        const request = new XMLHttpRequest();
        if(flag===true) {
            request.open('POST', '/change-user-status/activate/' + e.dataset.id, true);
        } else {
            request.open('POST', '/change-user-status/deactivate/' + e.dataset.id, true);
        }
        //request.setRequestHeader("Content-Type", "application/json");
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            console.log(data.message)
            alert(data.message)
            if (request.status===200){
                window.location.reload(false);
            }
        }

        // Send request
        request.send();
    };


    function delete_user(e){
        //alert(e.dataset.id, datepicker.value)
        const request = new XMLHttpRequest();
        request.open('DELETE', '/delete-user/' + e.dataset.id, true);
        //request.setRequestHeader("Content-Type", "application/json");
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            // console.log(data.message)
            alert(data.message)
            if (request.status===200){
                window.location.reload(false);
            }
        }


        // Send request
        request.send();
    };


    document.addEventListener("DOMContentLoaded", function (event) {
        const request = new XMLHttpRequest();
        request.open('GET', '/all-users/get-list', true);
        // request.setRequestHeader("Content-Type", "application/json");
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);

            if (request.status===200){
                t_data = toObject(data['data'])

                $.fn.dataTable.ext.errMode = 'none';
                $('#all_users').DataTable(
                    {
                        data: t_data,
                        columns: [
                            { 
                                data: 'email',
                                searchable: true
                            },
                            { 
                                data: 'username' ,
                                searchable: true
                            },
                            { 
                                data: 'time_created',
                                searchable: false
                            },
                            { 
                                data: 'last_login_time',
                                searchable: false
                            },
                            { 
                                data: 'active',
                                searchable: false,
                                render: function ( data, type, row ) {
                                    if (data.active==true) {
                                        return `<div class="form-check form-switch">
                                                    <input id="${data.id}" onclick="toggle_account_status(this)" 
                                                    class="form-check-input" type="checkbox" 
                                                    role="switch" data-id="${data.id}" 
                                                    data-state="1" checked>
                                                </div>`
                                    }
                                    else {
                                        return `<div class="form-check form-switch">
                                                    <input id="${data.id}" onclick="toggle_account_status(this)" 
                                                    class="form-check-input" type="checkbox" 
                                                    role="switch" data-id="${data.id}" data-state="0" >
                                                </div>` 
                                    }
                                }
                            },
                            { 
                                data: 'delete' ,
                                searchable: false,
                                render: function ( data, type, row ) {
                                    return `<button id="${data.id}" onclick="change_modal(this)" 
                                    data-type="delete" type="button" class="btn btn-warning delete" 
                                    data-id="${data.id}" data-toggle="modal" data-target="#delete_window">Delete</button>`
                                }
                            }
                        ],
                        columnDefs: [
                            {
                                targets: 0,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 1,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 2,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 3,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 4,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 5,
                                sorting: false,
                                className: 'dt-body-center'
                            }
                        ]
                    }
                ); 
            }
        }


        // Send request
        request.send();

    });

</script>
{% endblock %}