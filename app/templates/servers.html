{% extends "base.html" %}{% set active_page='servers' %}

{% block title %}SocialDroid{% endblock %}

{% block page_content %}
<div class="table table-responsive-sm">
    <table id="all_servers" class="table table-striped table-sm table-bordered">
        <thead>
            <tr>
                <th class="text-center">IP Address</th>
                <th class="text-center">Time Created</th>
                <th class="text-center">User</th>
                <th class="text-center">Sub-Type</th>
                <th class="text-center">Sub Expires</th>
                <th class="text-center">Activate</th>
                <th class="text-center">Delete</th>
                <th class="text-center">Description</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<div class="container-fluid mx-2 my-1">
    <div class="row">
        <div class="col-lg-15 mx-auto">
            <div class="card card-signin my-5">
                <div class="card-body">
                    <h4 class="text-center">Create Server</h4>
                    <form class="form-signup" method="POST" action="">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            {{ form.ip_address.label(class="form-control-label") }} {{ form.ip_address(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.description.label(class="form-control-label") }} {{ form.description(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.submit(class="btn btn-primary btn-block") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="delete_window" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-body mx-auto">
            <h4>Are you sure?</h4>
        </div>
        <div class="modal-footer mx-auto">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <a id="delete_confirm" class="btn btn-danger btn-ok" type="button" data-id="" onclick="delete_server(this)">Delete</a>
        </div>
    </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script type="text/javascript">
    function toObject(arr) {
        var rv = [];
        for (var i = 0; i < arr.length; ++i)
            rv[i] = arr[i];
        return rv;
    }

    function change_modal(e){
        if (e.dataset.type==='delete'){
            document.getElementById('delete_confirm').dataset.id = e.dataset.id;
        }
    };

    function change_subscription_date(e){
        var server_id = e.dataset.id;
        var date = e.value;

        const request = new XMLHttpRequest();

        request.open('POST', `/change-server-sub-date/${server_id}/${date}`, true);

        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            console.log(data.message)
            alert(data.message)
            // if (request.status===200){
            //     window.location.reload(true);
            // }
        }

        // Send request
        request.send();
    };

    function handleSubComboboxChange(e) {
        var server_id = e.dataset.id;
        var sub_id = e.value;

        const request = new XMLHttpRequest();

        request.open('POST', `/change-sub-for-server/${server_id}/${sub_id}`, true);
    
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            console.log(data.message)
            alert(data.message)
            if (request.status===200){
                window.location.reload(false);
            }
        }
        
        // Send request
        request.send();
    }


    function handleUserComboboxChange(e) {
        var server_id = e.dataset.id;
        var user_id = e.value;

        const request = new XMLHttpRequest();

        request.open('POST', `/change-user-for-server/${server_id}/${user_id}`, true);
    
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            console.log(data.message)
            alert(data.message)
            if (request.status===200){
                window.location.reload(false);
            }
        }
        
        // Send request
        request.send();
    }

    function toggle_server_status(e) {
        if (e.dataset.state==='1') {

            e.dataset.state = '0';
            change_server_status(e, false);
        } else {
            // turning active
            e.dataset.state = '1';
            change_server_status(e, true);
        }
        
    };

    function change_server_status(e, flag){

        const request = new XMLHttpRequest();
        if(flag===true) {
            request.open('POST', '/change-server-status/activate/' + e.dataset.id, true);
        } else {
            request.open('POST', '/change-server-status/deactivate/' + e.dataset.id, true);
        }
        //request.setRequestHeader("Content-Type", "application/json");
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            console.log(data.message)
            alert(data.message)
            if (request.status===200){
                window.location.reload(false);
            }
        }

        // Send request
        request.send();
    };


    function delete_server(e){
        const request = new XMLHttpRequest();
        request.open('DELETE', '/delete-server/' + e.dataset.id, true);
        //request.setRequestHeader("Content-Type", "application/json");
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            // console.log(data.message)
            alert(data.message)
            if (request.status===200){
                window.location.reload(false);
            }
        }


        // Send request
        request.send();
    };


    document.addEventListener("DOMContentLoaded", function (event) {
        const request = new XMLHttpRequest();
        request.open('GET', '/servers/get-all', true);
        // request.setRequestHeader("Content-Type", "application/json");
        request.onload = () => {

            // Extract JSON data from request
            const data = JSON.parse(request.responseText);
            if (request.status===200){
                t_data = toObject(data['data'])
                console.log(t_data);
                $.fn.dataTable.ext.errMode = 'none';
                $('#all_servers').DataTable(
                    {
                        data: t_data,
                        columns: [
                            { 
                                data: 'ip_address',
                                searchable: true
                            },
                            { 
                                data: 'time_created' ,
                                searchable: true
                            },
                            { 
                                data: 'user',
                                searchable: true,
                                render: function ( data, type, row ) {
                                    var element = `<div class="form-group">
                                    <select class="form-control" data-id="${data.server_id}" onchange="handleUserComboboxChange(this)">`;

                                    for ( var item in data.all_users ) {
                                        var flag = ``;
                                        if (data.email === data.all_users[item].email) {
                                            flag = `selected`;
                                        }
                                        element = element + `<option value="${data.all_users[item].id}" ${flag}="true" >
                                            ${data.all_users[item].email}</option>`;
                                    }

                                    if (data.id === null) {
                                        element = element + `<option value="-1" selected="true">None Selected</option>`;
                                    } else {
                                        element = element + `<option value="-1">None Selected</option>`;
                                    }

                                    element = element + `</select></div>`;

                                    return element
                                }
                            },
                            { 
                                data: 'sub_type' ,
                                searchable: true,
                                render: function ( data, type, row ) {
                                    var element = `<div class="form-group">
                                    <select class="form-control" data-id="${data.server_id}" onchange="handleSubComboboxChange(this)">`;

                                    for ( var item in data.all_subs ) {
                                        var flag = ``;
                                        if (data.name === data.all_subs[item].name) {
                                            flag = `selected`;
                                        }
                                        element = element + `<option value="${data.all_subs[item].id}" ${flag}="true" >
                                            ${data.all_subs[item].name}</option>`;
                                    }

                                    if (data.id === null) {
                                        element = element + `<option value="-1" selected="true">None Selected</option>`;
                                    } else {
                                        element = element + `<option value="-1">None Selected</option>`;
                                    }
                                    element = element + `</select></div>`;

                                    return element
                                }
                            },
                            { 
                                data: 'sub_end_date' ,
                                searchable: true,
                                render: function ( data, type, row ) {
                                    return `<input data-id="${data.id}" type="date" class="form-control" 
                                        value="${data.date}" aria-label="Date" onchange="change_subscription_date(this)" 
                                        aria-describedby="basic-addon1">`
                                }
                            },
                            { 
                                data: 'active',
                                searchable: false,
                                render: function ( data, type, row ) {
                                    if (data.active==true) {
                                        return `<div class="form-check form-switch">
                                                    <input id="${data.id}" onclick="toggle_server_status(this)" 
                                                    class="form-check-input" type="checkbox" 
                                                    role="switch" data-id="${data.id}" 
                                                    data-state="1" checked>
                                                </div>`
                                    }
                                    else {
                                        return `<div class="form-check form-switch">
                                                    <input id="${data.id}" onclick="toggle_server_status(this)" 
                                                    class="form-check-input" type="checkbox" 
                                                    role="switch" data-id="${data.id}" data-state="0" >
                                                </div>` 
                                    }
                                }
                            },
                            { 
                                data: 'delete' ,
                                searchable: false,
                                render: function ( data, type, row ) {
                                    return `<button id="${data.id}" onclick="change_modal(this)" 
                                    data-type="delete" type="button" class="btn btn-warning delete" 
                                    data-id="${data.id}" data-toggle="modal" data-target="#delete_window">Delete</button>`
                                }
                            },
                            { 
                                data: 'description' ,
                                searchable: false
                            }
                        ],
                        columnDefs: [
                            {
                                targets: 0,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 1,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 2,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 3,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 4,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 5,
                                sorting: false,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 6,
                                className: 'dt-body-center'
                            },
                            {
                                targets: 7,
                                className: 'dt-body-center'
                            },
                        ]
                    }
                ); 
            }
        }


        // Send request
        request.send();

    });

</script>
{% endblock %}